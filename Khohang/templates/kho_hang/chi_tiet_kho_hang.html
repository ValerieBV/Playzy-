{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<link href="https://fonts.googleapis.com/css2?family=Baloo+Bhai+2:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      integrity="sha512-2UeKX2frZlUIMJgAm/6Kw7uQvP8QKJkFzTrWQ2hfH8RJUpgI2VZrX2+l3GbzHY9L3Tx6eF4CjYDJh8MZ4Pz+LQ=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <style>
    body, input, select, button, table, th, td, label, h1 {
      font-family: 'Baloo Bhai 2', sans-serif !important;
    }
    .breadcrumb { font-size: 0.95em; color: #555; margin-bottom: 20px; }
    .breadcrumb strong { color: #E96607; }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-header h1 { color: #333; font-weight: 700; font-size: 2rem; display: flex; align-items: center; gap: 10px; }
    .btn-create { background-color: #1E90FF; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }

    .filter-container { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .filter-form { display: flex; align-items: flex-end; flex-wrap: wrap; gap: 15px; }
    .filter-form .form-group { display: flex; flex-direction: column; }
    .filter-form label { margin-bottom: 5px; color: #333; font-size: 14px; font-weight: 600; }
    .filter-form input, .filter-form select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; background: #f9f9f9; width: 180px; }
    .btn-search { background: #28a745; color: white; border: none; border-radius: 6px; padding: 11px 22px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }

    .table-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
    thead th { background: #1E90FF; color: white; font-weight: bold; }
    tbody tr:hover { background-color: #f5f5f5; }
    .status { padding: 5px 10px; border-radius: 12px; font-size: 0.9em; color: #fff; font-weight: bold; }
    .status-available { background: #28a745; }
    .status-out { background: #dc3545; }
    .row-add { background-color: #f0f8ff; }
    .row-add td { vertical-align: middle; }
    .row-add input, .row-add select { 
      width: 100%; 
      padding: 8px; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      box-sizing: border-box;
      font-size: 14px;
    }
    .btn-add-row { 
      background-color: #28a745; 
      color: white; 
      border: none; 
      padding: 8px 15px; 
      border-radius: 4px; 
      cursor: pointer;
      font-weight: bold;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .btn-add-row:hover { background-color: #218838; }
    .row-add form { margin: 0; display: contents; }
    table { table-layout: fixed; }
    th:nth-child(1), td:nth-child(1) { width: 5%; }
    th:nth-child(2), td:nth-child(2) { width: 12%; }
    th:nth-child(3), td:nth-child(3) { width: 25%; }
    th:nth-child(4), td:nth-child(4) { width: 15%; }
    th:nth-child(5), td:nth-child(5) { width: 12%; }
    th:nth-child(6), td:nth-child(6) { width: 12%; }
    th:nth-child(7), td:nth-child(7) { width: 19%; }
  </style>

  <div class="breadcrumb">
    <span>Quản lý kho hàng</span> &gt; <strong>Chi tiết kho hàng</strong>
  </div>

  <div class="page-header">
    <h1><i class="fas fa-warehouse"></i> Chi tiết kho hàng</h1>
    <a href="{% url 'Khohang:them_giao_dich' %}" class="btn-create">
      <i class="fas fa-plus"></i> Thêm giao dịch
    </a>
  </div>

  <!-- Bộ lọc -->
  <div class="filter-container">
    <form method="get" class="filter-form">
      <div class="form-group">
        <label for="ma_sp">Mã sản phẩm</label>
        <input type="text" name="ma_sp" value="{{ request.GET.ma_sp }}">
      </div>
      <div class="form-group">
        <label for="ten_sp">Tên sản phẩm</label>
        <input type="text" name="ten_sp" value="{{ request.GET.ten_sp }}">
      </div>
      <div class="form-group">
        <label for="danh_muc">Danh mục</label>
        <select name="danh_muc">
          <option value="">Tất cả</option>
          {% for dm in danh_muc_list %}
            <option value="{{ dm.ma_danh_muc }}" {% if request.GET.danh_muc == dm.ma_danh_muc %}selected{% endif %}>{{ dm.ten_danh_muc }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="tu_gia">Từ giá</label>
        <input type="number" name="tu_gia" value="{{ request.GET.tu_gia }}">
      </div>
      <div class="form-group">
        <label for="den_gia">Đến giá</label>
        <input type="number" name="den_gia" value="{{ request.GET.den_gia }}">
      </div>
      <button type="submit" class="btn-search">
        <i class="fas fa-search"></i> Tìm kiếm
      </button>
    </form>
  </div>

  <!-- Bảng -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>STT</th>
          <th>Mã sản phẩm</th>
          <th>Tên sản phẩm</th>
          <th>Danh mục</th>
          <th>Số lượng tồn</th>
          <th>Giá nhập</th>
          <th>Trạng thái</th>
        </tr>
      </thead>
      <tbody>
        {% for sp in danh_sach_ton_kho %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ sp.ma_sp.ma_sp }}</td>
          <td>{{ sp.ma_sp.ten_sp }}</td>
          <td>{{ sp.ma_sp.danh_muc.ten_danh_muc }}</td>
          <td>{{ sp.so_luong_ton_kho }}</td>
          <td>{{ sp.ma_sp.gia_goc|floatformat:0 }}₫</td>
          <td>
            {% if sp.so_luong_ton_kho > 0 %}
              <span class="status status-available">Còn hàng</span>
            {% else %}
              <span class="status status-out">Hết hàng</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-muted">Không có sản phẩm nào trong kho.</td></tr>
        {% endfor %}
        <!-- Hàng thêm sản phẩm mới -->
        <tr class="row-add">
          <form method="post" id="form-them-san-pham" style="display: contents;">
            {% csrf_token %}
            <input type="hidden" name="them_san_pham" value="1">
            <td>{{ danh_sach_ton_kho|length|add:1 }}</td>
            <td>
              <select name="ma_sp" required>
                <option value="">-- Chọn sản phẩm --</option>
                {% for sp in san_pham_chua_co_kho %}
                  <option value="{{ sp.ma_sp }}">[{{ sp.ma_sp }}] {{ sp.ten_sp }}</option>
                {% endfor %}
              </select>
            </td>
            <td colspan="2" style="color: #999;">-</td>
            <td>
              <input type="number" name="so_luong_ton_kho" min="0" value="0" required>
            </td>
            <td style="color: #999;">-</td>
            <td>
              <button type="submit" class="btn-add-row">
                <i class="fas fa-plus"></i> Thêm
              </button>
            </td>
          </form>
        </tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
