{% load static %}
{# C·∫©m ƒë√£ s·ª≠a - File base.html chung cho to√†n d·ª± √°n, g·ªôp t·ª´ templates/base.html v√† Sanpham/templates/Sanpham/base.html #}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Playzy - Vui ch∆°i s√°ng t·∫°o{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link href="https://fonts.googleapis.com/css?family=Baloo+Bhai&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Jersey+20&display=swap" rel="stylesheet" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    {% block head_css %}{% endblock %}

    <style>
        /* ... (CSS header kh√¥ng ƒë·ªïi) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            padding-top: 102px;
            font-family: 'Baloo Bhai', sans-serif; /* Gi·ªØ nguy√™n font c·ªßa b·∫°n */
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: #4b2c20;
        }
        main { flex: 1; }
        .header-container { width: 100%; height: 102px; position: fixed; top: 0; left: 0; background: #fff; z-index: 1000; border-bottom: 1px solid #ddd; }
        .search-form { padding-left: 12px; padding-right: 12px; left: 409px; top: 25px; position: absolute; background: rgba(141.97, 199.24, 255, 0.34); border-radius: 10px; outline: 1px #1E90FF solid; outline-offset: -1px; justify-content: flex-start; align-items: center; gap: 10px; display: inline-flex; }
        .search-form input { width: 369px; height: 26px; border: none; background: transparent; outline: none; color: #1E90FF; font-size: 16px; font-family: 'Baloo Bhai', sans-serif; }
        .search-form input::placeholder { color: rgba(17, 149.60, 238, 0.33); }
        .search-form button { background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }
        .search-form .fa-magnifying-glass { font-size: 20px; color: #1E90FF; }
        .nav-bar { width: 100%; height: 30px; padding: 0 189px; box-sizing: border-box; left: 0px; top: 72px; position: absolute; background: #1E90FF; justify-content: space-between; align-items: center; display: inline-flex; }
        .nav-bar a { flex-grow: 1; width: 187px; height: 30px; text-align: center; line-height: 30px; color: #F5F5F5; font-size: 18px; font-family: 'Baloo Bhai', sans-serif; font-weight: 400; text-decoration: none; }
        .nav-bar a.active, .nav-bar a:hover { color: #E96607; }
        .logo-text { width: 136px; height: 72px; left: 98px; top: 0px; position: absolute; font-family: 'Jersey 20', sans-serif; font-size: 60px; line-height: 72px; text-decoration: none; }
        .logo-play { color: #1E90FF; }
        .logo-zy { color: #E96607; }
        .user-icons { position: absolute; right: 98px; top: 25px; display: flex; gap: 20px; align-items: center; }
        .user-icons a { font-size: 24px; color: #1E90FF; text-decoration: none; }

        /* ====== CSS FOOTER ====== */
        footer {
            background-color: #ffe3ca;
            color: #ff6f00;
            padding: 25px 0 5px 0;
            margin-top: auto;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
            font-family: "Arial", sans-serif; /* Gi·ªØ nguy√™n font Arial cho footer */
        }
        .footer { max-width: 1150px; margin: 0 auto; padding: 0 20px; }
        .footer-container { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; padding-bottom: 10px; }
        .footer-column { flex: 1; min-width: 220px; margin: 5px 10px; line-height: 1.7; }
        .footer-column .logo { font-size: 42px; font-weight: 800; color: #ff6f00; letter-spacing: 0.5px; font-family: 'Jersey 20', sans-serif; }
        .footer-column .logo span { color: #2a8ef7; }

        /* C·ªòT TI√äU ƒê·ªÄ */
        footer h3 {
            color: #ff6f00;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;

            /* 2. S·ª¨A FONT V√Ä C·ª† CH·ªÆ CHO H3 */
            font-family: 'Roboto', sans-serif;
            font-weight: 900;
            font-size: 18px; /* Gi·∫£m c·ª° ch·ªØ ƒë·ªÉ kh√¥ng b·ªã tr√†n */
        }

        .footer-column p,
        .footer-column a {
            font-size: 14.5px;
            color: #ff6f00;
            font-weight: 600;
            text-decoration: none;
            font-family: "Arial", sans-serif; /* ƒê·∫£m b·∫£o ch·ªØ nh·ªè v·∫´n l√† Arial */
        }
        .footer-column a:hover { text-decoration: underline; }
        .social-icons a { color: #ff6f00; margin-right: 12px; font-size: 18px; transition: 0.3s; }
        .social-icons a:hover { transform: scale(1.1); }
        .buy-btn { display: inline-block; background: #e65c00; color: #ffffff !important; font-size: 17px; font-weight: 800; padding: 14px 60px; border-radius: 80px; text-decoration: none; text-align: center; letter-spacing: 1px; border: none; box-shadow: 0 3px 6px rgba(0,0,0,0.08); transition: all 0.25s ease; }
        .buy-btn:hover { background: #cc5200; transform: translateY(-2px); color: #ffffff !important; }
        .footer-bottom { text-align: center; margin-top: 5px; }
        .footer-bottom hr { border: none; border-top: 1.2px solid #2a8ef7; width: 96%; margin: 0 auto 6px auto; }
        .footer-bottom p { font-size: 13.8px; font-weight: 700; color: #ff6f00; }
        @media (max-width: 768px) {
            .footer-container { flex-direction: column; }
            .footer-column { width: 100%; margin-bottom: 10px; }
            .buy-btn { width: 100%; text-align: center; }
        }
    </style>
</head>
<body>

<div class="header-container">
    <form action="{% url 'Sanpham:trang_danh_muc' %}" method="GET" class="search-form">
        <button type="submit">
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
        <input type="text" name="q" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." value="{{ query|default:'' }}">
    </form>
    <div class="nav-bar">
        <a href="{% url 'home' %}" {% if request.resolver_match.url_name == 'home' %}class="active"{% endif %}>Trang ch·ªß</a>
        <a href="{% url 'gioi_thieu' %}" {% if request.resolver_match.url_name == 'gioi_thieu' %}class="active"{% endif %}>Gi·ªõi thi·ªáu</a>
        <a href="{% url 'Sanpham:trang_danh_muc' %}" {% if request.resolver_match.url_name == 'trang_danh_muc' %}class="active"{% endif %}>Danh m·ª•c</a>
        <a href="{% url 'Tintuc:trang_tintuc' %}" {% if request.resolver_match.url_name == 'trang_tintuc' %}class="active"{% endif %}>Tin t·ª©c</a>
        <a href="{% url 'Lienhe:cau_hoi' %}" {% if request.resolver_match.url_name == 'cau_hoi' %}class="active"{% endif %}>Li√™n h·ªá</a>
    </div>
    <div class="user-icons">
        {% if user.is_authenticated %}
            <!-- ƒê√£ ƒëƒÉng nh·∫≠p: Hi·ªÉn th·ªã menu ng∆∞·ªùi d√πng -->
    <div class="dropdown">
                <a href="#" class="text-decoration-none" role="button" id="userDropdownLink"
                   data-bs-toggle="dropdown" aria-expanded="false"
                   style="font-size: 24px; color: #1E90FF;">
                    <i class="fa-solid fa-user"></i>
                    <span style="font-size: 14px; margin-left: 5px; color: #1E90FF;">{{ user.username }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdownLink"
                    style="min-width: 200px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <li><a class="dropdown-item" href="{% url 'thong_tin_ca_nhan' %}">
                        <i class="fa-solid fa-user-circle"></i> Th√¥ng tin c√° nh√¢n</a></li>
                    <li><a class="dropdown-item" href="{% url 'Muahang:theo_doi_don_hang' %}">
                        <i class="fa-solid fa-history"></i> L·ªãch s·ª≠ mua h√†ng</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'dangxuat' %}">
                        <i class="fa-solid fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </div>
        {% else %}
            <!-- Ch∆∞a ƒëƒÉng nh·∫≠p: Hi·ªÉn th·ªã link ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω -->
            <a href="{% url 'dangnhap' %}" style="font-size: 16px; color: #1E90FF; text-decoration: none; margin-right: 15px;">
                <i class="fa-solid fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
            </a>
            <a href="{% url 'dangky' %}" style="font-size: 16px; color: #E96607; text-decoration: none;">
                <i class="fa-solid fa-user-plus"></i> ƒêƒÉng k√Ω
            </a>
        {% endif %}

        <!-- Gi·ªè h√†ng -->
        <div class="dropdown" style="margin-left: 15px;">
        <a href="{% url 'Muahang:giohang' %}"
           class="position-relative text-decoration-none"
           role="button"
           id="cartDropdownLink"
           data-bs-toggle="dropdown"
           aria-expanded="false"
           style="font-size: 24px; color: #1E90FF;">

            <i class="fa-solid fa-cart-shopping"></i>

            <span id="cart-count" class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill"
                  style="font-size: 12px;">
                {{ cart_total_items|default:0 }}
            </span>
        </a>

        <div class="dropdown-menu dropdown-menu-end p-0"
             aria-labelledby="cartDropdownLink"
             data-bs-auto-close="outside"
             style="width: 320px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);max-height: 1000px; overflow-y: auto;"
             onclick="event.stopPropagation();">

            <div id="mini-cart-container" onclick="event.stopPropagation();">
                <div class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> ƒêang t·∫£i...</div>
            </div>

        </div>
    </div>
</div>
    <a href="{% url 'home' %}" class="logo-text">
        <span class="logo-play">PLAY</span><span class="logo-zy">ZY</span>
    </a>
</div>

<main>
    {% block content %}
    {% endblock %}
</main>

<footer>
    <div class="footer">
        <div class="footer-container">
            <div class="footer-column">
                <div class="logo"><span>PLAY</span>ZY</div>
            </div>
            <div class="footer-column">
                <h3>TH√îNG TIN LI√äN H·ªÜ</h3>
                <p><i class="fa-solid fa-phone"></i> <b>Hotline:</b> 0374691634</p>
                <p><i class="fa-solid fa-location-dot"></i> <b>ƒê·ªãa ch·ªâ:</b> 71 Ng≈© H√†nh S∆°n</p>
                <p><i class="fa-solid fa-envelope"></i> <b>Email:</b> <a href="mailto:playzyltw@gmail.com">playzyltw@gmail.com</a></p>
            </div>
            <div class="footer-column">
                <h3>CH√çNH S√ÅCH</h3>
                <a href="#">Khuy·∫øn m√£i</a><br>
                <a href="{% url 'chinh_sach_bao_mat' %}">Ch√≠nh s√°ch b·∫£o m·∫≠t th√¥ng tin</a><br>
                <a href="#">H∆∞·ªõng d·∫´n mua h√†ng</a><br>
                <a href="#">Xem b·∫£n ƒë·ªì ƒë∆∞·ªùng ƒëi</a>
            </div>
            <div class="footer-column">
                <h3>THEO D√ïI CH√öNG T√îI</h3>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
                <a href="{% url 'Sanpham:trang_danh_muc' %}" class="buy-btn">MUA NGAY</a>
            </div>
        </div>
        <div class="footer-bottom">
            <hr>
            <p>PLAYZY - r·∫•t nhi·ªÅu tr√≤ ch∆°i phong ph√∫, n√¢ng t·∫ßm gi·∫£i tr√≠ v√† g·∫Øn k·∫øt m·ªçi ng∆∞·ªùi v·ªõi ni·ªÅm vui b·∫•t t·∫≠n</p>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    /**
     * H√ÄM 1: L√ÄM M·ªöI MINI-CART (Code b·∫°n ƒë√£ th√™m)
     * ƒê√£ ƒë∆∞·ª£c b·ªçc l·∫°i ch√≠nh x√°c trong th·∫ª <script>
     */
    // C·∫©m ƒë√£ s·ª≠a - C·∫£i thi·ªán h√†m refreshMiniCart ƒë·ªÉ tr·∫£ v·ªÅ Promise v√† ch·∫°y l·∫°i script trong HTML m·ªõi
    function refreshMiniCart() {
        return fetch("{% url 'Muahang:mini_cart' %}")
            .then(res => {
                // Ki·ªÉm tra xem server c√≥ tr·∫£ v·ªÅ l·ªói kh√¥ng
                if (res.ok) {
                    return res.json();
                }
                throw new Error('L·ªói m·∫°ng ho·∫∑c server.');
            })
            .then(data => {
                // Ch√®n HTML ƒë∆∞·ª£c tr·∫£ v·ªÅ v√†o div
                const container = document.getElementById("mini-cart-container");
                if (container) {
                    container.innerHTML = data.html;
                    
                    // C·∫©m ƒë√£ s·ª≠a - Ch·∫°y l·∫°i c√°c script trong HTML m·ªõi ƒë∆∞·ª£c ch√®n v√†o
                    const scripts = container.querySelectorAll('script');
                    scripts.forEach(function(oldScript) {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                    
                    // ƒê·∫£m b·∫£o event listener ƒë∆∞·ª£c attach l·∫°i sau khi load content m·ªõi
                    setTimeout(function() {
                        const container = document.getElementById('mini-cart-container');
                        if (container) {
                            // Re-attach event listener cho n√∫t c·ªông/tr·ª´
                            const qtyButtons = container.querySelectorAll('.qty-btn');
                            qtyButtons.forEach(function(btn) {
                                btn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                });
                            });
                        }
                    }, 100);
                }
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i mini-cart:", error);
                const container = document.getElementById("mini-cart-container");
                if (container) {
                    container.innerHTML = "<div class='p-3 text-danger'>L·ªói t·∫£i gi·ªè h√†ng.</div>";
                }
            });
    }

    /**
     * H√ÄM 2: TH√äM GI·ªé H√ÄNG (Code c≈© c·ªßa b·∫°n)
     * ƒê√£ ƒë∆∞·ª£c g·ªôp v√†o ƒë√¢y v√† C·∫¨P NH·∫¨T ƒë·ªÉ g·ªçi refreshMiniCart()
     */
    function themGioHang(productId) {
        fetch(`/gio-hang/them/${productId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}", // C·∫ßn c√≥ CSRF token
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                // 1. C·∫≠p nh·∫≠t s·ªë tr√™n icon
                document.getElementById("cart-count").innerText = data.total_items;

                // 2. T·∫£i l·∫°i n·ªôi dung mini-cart (ƒê√É TH√äM)
                refreshMiniCart();

                // 3. Th√¥ng b√°o (gi·ªØ nguy√™n alert c·ªßa b·∫°n)
                alert(data.message);
            } else {
                alert("L·ªói: " + data.message);
            }
        })
        .catch(error => {
             console.error("L·ªói khi th√™m gi·ªè h√†ng:", error);
             alert("L·ªói k·∫øt n·ªëi. Kh√¥ng th·ªÉ th√™m gi·ªè h√†ng.");
        });
    }

    /**
    /**
 * H√ÄM 3: T·ª∞ ƒê·ªòNG CH·∫†Y KHI T·∫¢I TRANG (ƒê√É TH√äM)
 * T·ª± ƒë·ªông t·∫£i n·ªôi dung mini-cart khi b·∫°n m·ªü b·∫•t k·ª≥ trang n√†o.
 */
document.addEventListener("DOMContentLoaded", function() {
    refreshMiniCart();

    // üî∏ TH√äM: Hi·ªáu ·ª©ng ƒë·ªïi m√†u icon gi·ªè h√†ng khi m·ªü / ƒë√≥ng dropdown
    const cartLink = document.getElementById("cartDropdownLink");
    const cartIcon = document.querySelector("#cartDropdownLink i.fa-cart-shopping");

    if (cartLink && cartIcon) {
        cartLink.addEventListener("show.bs.dropdown", function() {
            cartIcon.style.color = "#E96607"; // cam khi m·ªü
        });
        cartLink.addEventListener("hide.bs.dropdown", function() {
            cartIcon.style.color = "#1E90FF"; // xanh khi ƒë√≥ng
        });
    }
});

</script>
</body>
</html>